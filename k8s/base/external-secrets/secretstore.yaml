# ServiceAccount for ELK Secrets
# Context: ft-transcendence DevOps Module
# Component: External Secrets Operator Integration
#
# This ServiceAccount is used by the External Secrets Operator's SecretStore
# to authenticate with Vault. It is bound to the 'elk-role' in Vault
# via the Kubernetes Auth Method.
apiVersion: v1
kind: ServiceAccount
metadata:
  name: elk-secrets-sa
  namespace: logging
  annotations:
    # Optional: useful for documentation/audit
    description: "ServiceAccount used by SecretStore to authenticate with Vault for ELK stack secrets"
---
# SecretStore Configuration
# Context: ft-transcendence DevOps Module
# Component: External Secrets Operator
#
# A SecretStore maps a Kubernetes Namespace (here 'logging') to a secrets provider (Vault).
# It defines HOW to retrieve secrets.
#
# This specific SecretStore uses the Vault provider with Kubernetes Authentication.
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: logging
spec:
  provider:
    vault:
      # Address of the Vault service within the cluster
      server: "http://vault.vault.svc.cluster.local:8200"

      # Path to the secret engine. We use KV version 2.
      path: "secret"

      # Version of the KV engine (v1 or v2). We use v2 for versioning support.
      version: "v2"

      # Authentication configuration
      auth:
        kubernetes:
          # The path where the Kubernetes Auth Method is mounted in Vault.
          # Default is "kubernetes", but can be customized (e.g. "k8s-cluster-1")
          mountPath: "kubernetes"

          # The Vault Role to assume.
          # This role must be configured in Vault to allow this ServiceAccount (elk-secrets-sa)
          # to access the specific policies (elk-policy).
          role: "elk-role"

          # Reference to the ServiceAccount token used for authentication.
          # We use the ServiceAccount created above.
          serviceAccountRef:
            name: elk-secrets-sa
            # Key is typically 'token' for ServiceAccount secrets, but with recent K8s versions
            # and projected volumes, ESO handles SA tokens automatically if name is provided.
