# Configuration Nginx Ingress Controller pour Helm
# Ref: https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx

controller:
  name: controller
  image:
    registry: registry.k8s.io
    image: ingress-nginx/controller
    tag: 'v1.10.1'
    digest: '' # Laisser Helm gérer ou fixer si nécessaire

  # Simplification du nom
  fullnameOverride: nginx-ingress-controller

  replicaCount: 2

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Configuration (ConfigMap)
  config:
    use-forwarded-headers: 'true'
    compute-full-forwarded-for: 'true'
    use-proxy-protocol: 'false'

    # Monitoring
    enable-vts-status: 'true'

    # Logs
    log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id'

    # Limits
    proxy-body-size: '10m'
    client-body-buffer-size: '128k'

    # Timeouts
    proxy-connect-timeout: '60'
    proxy-send-timeout: '60'
    proxy-read-timeout: '60'

    # Performance
    worker-processes: 'auto'
    max-worker-connections: '16384'
    enable-gzip: 'true'
    gzip-types: 'application/json application/javascript application/xml text/css text/javascript text/plain text/xml'

    # SSL
    enable-ssl-passthrough: 'false'

    # Security (WAF)
    # Note: enable-owasp-modsecurity-crs inclut automatiquement les règles CRS
    # Ne pas dupliquer avec modsecurity-snippet pour éviter les erreurs de configuration
    enable-modsecurity: 'true'
    enable-owasp-modsecurity-crs: 'true'
    # modsecurity-snippet peut être utilisé pour des règles personnalisées supplémentaires si nécessaire

  # Service
  service:
    type: LoadBalancer # Sera probablement NodePort en Dev via overlay, mais LoadBalancer par défaut est logique pour Ingress
    # loadBalancerIP: ... (si IP statique)

  # IngressClass
  ingressClassResource:
    name: nginx
    enabled: true
    default: true
    controllerValue: 'k8s.io/ingress-nginx'

  # Metrics
  metrics:
    enabled: true
    service:
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '10254'

  # Security Context
  allowPrivilegeEscalation: false

  # Admission Webhooks
  # Configuration des webhooks d'admission pour la validation des ressources Ingress
  admissionWebhooks:
    enabled: true
    # Nettoyage automatique des Jobs d'admission après succès (en secondes)
    # 0 = suppression immédiate, > 0 = suppression après X secondes, null = pas de suppression
    # Recommandé: 3600 (1 heure) pour permettre le débogage tout en gardant un cluster propre
    createSecretJob:
      ttlSecondsAfterFinished: 3600
    patchWebhookJob:
      ttlSecondsAfterFinished: 3600
