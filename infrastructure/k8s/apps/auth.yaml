apiVersion: v1
kind: Service
metadata:
  name: auth
  labels:
    app: auth
spec:
  ports:
    - port: 3000
      targetPort: 3000
      name: http
  selector:
    app: auth
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: auth
spec:
  serviceName: auth
  replicas: 1
  selector:
    matchLabels:
      app: auth
  template:
    metadata:
      labels:
        app: auth
      annotations:
        # ======================================================================
        # CONFIGURATION DE L'INJECTION VAULT (Zero Trust)
        # ======================================================================
        # 1. Active l'injection du sidecar Vault Agent dans ce Pod
        vault.hashicorp.com/agent-inject: "true"
        
        # 2. Spécifie le rôle (doit correspondre à celui configuré dans Vault)
        vault.hashicorp.com/role: "auth-role"
        
        # 3. Définit quel secret récupérer (Chemin KV v2)
        vault.hashicorp.com/agent-inject-secret-config: "secret/data/app/auth"
        
        # 4. Formate le fichier de sortie (.env)
        # Ce template écrit un fichier que l'application pourra "sourcer"
        vault.hashicorp.com/agent-inject-template-config: |
          {{- with secret "secret/data/app/auth" -}}
            {{- range $k, $v := .Data.data }}
            export {{ $k | toUpper }}={{ $v | toJSON }}
            {{- end }}
          {{- end -}}
    spec:
      serviceAccountName: auth
      
      # SÉCURITÉ : fsGroup configure automatiquement les droits du volume /data
      # L'utilisateur 1000 (node) pourra lire et écrire dedans.
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000

      containers:
        - name: auth
          image: auth:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 3000
          command: ["/bin/sh", "-c"]
          # Chargement des secrets puis lancement de l'application
          args: [". /vault/secrets/config && node apps/auth/dist/src/index.js"]
          
          volumeMounts:
            - name: data-volume
              mountPath: /data
          
          # Vérifie que l'API répond
          livenessProbe:
            httpGet:
              path: /auth/health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 15
          
          readinessProbe:
            httpGet:
              path: /auth/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5

  volumeClaimTemplates:
    - metadata:
        name: data-volume
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: "local-path"
        resources:
          requests:
            storage: 100Mi
