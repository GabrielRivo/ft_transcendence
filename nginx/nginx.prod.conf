worker_processes auto;
error_log /dev/stderr warn;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Optimisations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    server_tokens off;
    
    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # Logging
    log_format prod_format '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'rt=$request_time uct=$upstream_connect_time';
    access_log /dev/stdout prod_format;

    # Upstreams
    upstream auth_upstream { server auth:3000; }
    upstream user_upstream { server user:3000; }
    upstream game_upstream { server game:3000; }
    upstream chat_upstream { server chat:3000; }
    upstream matchmaking_upstream { server matchmaking:3000; }
    upstream tournament_upstream { server tournament:3000; }
    upstream stats_upstream { server stats:3000; }

    upstream frontend_upstream { server frontend:80; }

    # WebSocket Upgrade
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }


    # pour cloudflare
    server {
        listen 1234;
        server_name localhost;
        
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";

        client_max_body_size 10M;

        # Internal Auth Verify
        location = /internal/auth/verify {
            internal;
            proxy_pass http://auth_upstream/auth/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;
        }

        location = /internal/auth/verifyGuest {
            internal;
            proxy_pass http://auth_upstream/auth/verifyGuest;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;
        }

        # Public Auth Routes
        location /api/auth/ {
            rewrite ^/api/auth/(.*) /auth/$1 break;
            proxy_pass http://auth_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Images
        location /api/images/ {
            add_header X-Content-Type-Options nosniff;
            # Les images sont servies par NGINX directement via volume partagé si possible,
            # ou via le service user/autre qui les gère.
            # Dans le docker-compose dev, images-data était monté sur nginx:/app/images
            # Et nginx dev avait "alias /app/images/;"
            alias /app/images/;
        }

        # Protected Routes (User)
        location /api/user/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/user/(.*) /$1 break;
            proxy_pass http://user_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Game)
        location /api/game/ {
            auth_request /internal/auth/guestVerify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/game/(.*) /$1 break;
            proxy_pass http://game_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Chat)
        location /api/chat/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/chat/(.*) /$1 break;
            proxy_pass http://chat_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Matchmaking)
        location /api/matchmaking/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/matchmaking/(.*) /$1 break;
            proxy_pass http://matchmaking_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Tournament)
        location /api/tournament/ {
            auth_request /internal/auth/guestVerify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/tournament/(.*) /$1 break;
            proxy_pass http://tournament_upstream;
             
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
        
        # Protected Routes (Stats)
        location /api/stats/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/stats/(.*) /$1 break;
            proxy_pass http://stats_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
        }

        # Protected Routes (Social)


        # Frontend (Default)
        location / {
            proxy_pass http://frontend_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # NGINX Health
        location /nginx-health {
            access_log off;
            return 200 'healthy\n';
            add_header Content-Type text/plain;
        }
    }

    # HTTP -> HTTPS Redirect
    server {
        listen 80;
        server_name localhost;
        return 301 https://$host$request_uri:8443;
    }

    # Main HTTPS Server
    server {
        listen 443 ssl;
        server_name localhost;

        # SSL Configuration
        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Security Headers
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";

        client_max_body_size 10M;

        # Internal Auth Verify
        location = /internal/auth/verify {
            internal;
            proxy_pass http://auth_upstream/auth/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;
        }

        location = /internal/auth/verifyGuest {
            internal;
            proxy_pass http://auth_upstream/auth/verifyGuest;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;
        }

        # Public Auth Routes
        location /api/auth/ {
            rewrite ^/api/auth/(.*) /auth/$1 break;
            proxy_pass http://auth_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Images
        location /api/images/ {
            add_header X-Content-Type-Options nosniff;
            # Les images sont servies par NGINX directement via volume partagé si possible,
            # ou via le service user/autre qui les gère.
            # Dans le docker-compose dev, images-data était monté sur nginx:/app/images
            # Et nginx dev avait "alias /app/images/;"
            alias /app/images/;
        }

        # Protected Routes (User)
        location /api/user/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/user/(.*) /$1 break;
            proxy_pass http://user_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Game)
        location /api/game/ {
            auth_request /internal/auth/guestVerify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/game/(.*) /$1 break;
            proxy_pass http://game_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Chat)
        location /api/chat/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/chat/(.*) /$1 break;
            proxy_pass http://chat_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Matchmaking)
        location /api/matchmaking/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/matchmaking/(.*) /$1 break;
            proxy_pass http://matchmaking_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # Protected Routes (Tournament)
        location /api/tournament/ {
            auth_request /internal/auth/guestVerify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/tournament/(.*) /$1 break;
            proxy_pass http://tournament_upstream;
             
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
        
        # Protected Routes (Stats)
        location /api/stats/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            
            rewrite ^/api/stats/(.*) /$1 break;
            proxy_pass http://stats_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-User-Id $auth_user_id;
        }

        # Protected Routes (Social)


        # Frontend (Default)
        location / {
            proxy_pass http://frontend_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # NGINX Health
        location /nginx-health {
            access_log off;
            return 200 'healthy\n';
            add_header Content-Type text/plain;
        }
    }
}
