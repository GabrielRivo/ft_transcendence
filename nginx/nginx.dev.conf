# =============================================================================
# NGINX Configuration - Development Reverse Proxy
# =============================================================================
#
# This configuration provides a unified entry point for the ft_transcendence
# application during local development. It routes requests to the appropriate
# microservice based on URL path and handles WebSocket upgrades for real-time
# features (Socket.IO, Vite HMR).
#
# Architecture:
#   Browser -> NGINX:80 -> Backend services (port 3000) / Frontend (port 5173)
#
# Services:
#   - /api/auth/*        -> auth:3000        (Authentication, JWT, OAuth)
#   - /api/user/*        -> user:3000        (User profiles, friends, stats)
#   - /api/game/*        -> game:3000        (Pong game server)
#   - /api/chat/*        -> chat:3000        (Real-time messaging)
#   - /api/matchmaking/* -> matchmaking:3000 (ELO matchmaking, tournaments)
#   - /*                 -> frontend:5173    (Vite dev server)
#
# =============================================================================

# -----------------------------------------------------------------------------
# Worker Processes Configuration
# -----------------------------------------------------------------------------
# 'auto' sets the number of worker processes to match the number of CPU cores
# This is optimal for most workloads
worker_processes auto;

# -----------------------------------------------------------------------------
# Error Logging
# -----------------------------------------------------------------------------
# Log errors to stderr for Docker compatibility (visible in docker logs)
# 'warn' level captures warnings and errors without being too verbose
error_log /dev/stderr warn;

# -----------------------------------------------------------------------------
# Events Block
# -----------------------------------------------------------------------------
# Configuration for connection processing
events {
    # Maximum simultaneous connections per worker
    # 1024 is sufficient for development; increase for production
    worker_connections 1024;
    
    # Accept multiple connections at once (improves performance)
    multi_accept on;
}

# -----------------------------------------------------------------------------
# HTTP Block
# -----------------------------------------------------------------------------
http {
    # -------------------------------------------------------------------------
    # Basic Settings
    # -------------------------------------------------------------------------
    
    # Include MIME types for proper Content-Type headers
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Optimize file transfers
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Keep-alive timeout (seconds)
    keepalive_timeout 65;
    
    # Hide NGINX version in response headers (security best practice)
    server_tokens off;
    
    # -------------------------------------------------------------------------
    # Logging Format
    # -------------------------------------------------------------------------
    # Custom format with timing information for debugging
    log_format dev_format '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'rt=$request_time uct=$upstream_connect_time '
                          'uht=$upstream_header_time urt=$upstream_response_time';
    
    # Log to stdout for Docker compatibility
    access_log /dev/stdout dev_format;
    
    # -------------------------------------------------------------------------
    # Gzip Compression (disabled in dev for faster debugging)
    # -------------------------------------------------------------------------
    # Uncomment for production-like testing:
    # gzip on;
    # gzip_types text/plain text/css application/json application/javascript;
    
    # -------------------------------------------------------------------------
    # Upstream Definitions
    # -------------------------------------------------------------------------
    # Define backend service groups for load balancing and health checks
    # In development, each upstream has a single server
    
    upstream auth_upstream {
        server auth:3000;
        keepalive 8;
    }
    
    upstream user_upstream {
        server user:3000;
        keepalive 8;
    }
    
    upstream game_upstream {
        server game:3000;
        keepalive 8;
    }
    
    upstream chat_upstream {
        server chat:3000;
        keepalive 8;
    }
    
    upstream matchmaking_upstream {
        server matchmaking:3000;
        keepalive 8;
    }

    upstream social_upstream {
        server user:3000;
        keepalive 8;
    }
    

    upstream tournament_upstream {
        server tournament:3000;
        keepalive 8;
    }
    
    upstream frontend_upstream {
        server frontend:5173;
        keepalive 8;
    }

    upstream stats_upstream {
        server stats:3000;
        keepalive 8;
    }
    
    # -------------------------------------------------------------------------
    # WebSocket Upgrade Map
    # -------------------------------------------------------------------------
    # This map determines whether to upgrade the connection to WebSocket
    # based on the Upgrade header from the client
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    
    # -------------------------------------------------------------------------
    # Main Server Block
    # -------------------------------------------------------------------------
    server {
        # Listen on port 80 (HTTP)
        # In production, use 443 with SSL; for dev, plain HTTP is fine
        listen 80;
        server_name localhost;
        # server_name localhost dev.ft-transcendence.rafaelsequeira.com;
        
        # Maximum request body size (for file uploads like avatars)
        client_max_body_size 10M;
        client_body_buffer_size 128k;
        
        # Utiliser pour la validation du token JWT (utilisateurs authentifiés uniquement, pas les guests)
        location = /internal/auth/verify {
            internal;
            
            proxy_pass http://auth_upstream/auth/verify;
            
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;
            
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
        }

        # Utiliser pour la validation du token JWT (guests ET utilisateurs authentifiés)
        location = /internal/auth/verifyGuest {
            internal;
            
            proxy_pass http://auth_upstream/auth/verifyGuest;
            
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header Host $host;
            proxy_set_header Cookie $http_cookie;
            
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
        }
        
        # ---------------------------------------------------------------------
        # API Routes - Authentication Service (Public - No auth_request)
        # ---------------------------------------------------------------------
        location /api/images/ {
            add_header X-Content-Type-Options nosniff;
            alias /app/images/;
        }
        
        location /api/auth/ {
            # Rewrite /api/auth/* to /auth/* (keep the /auth prefix)
            rewrite ^/api/auth/(.*) /auth/$1 break;
            
            proxy_pass http://auth_upstream;
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts for slow operations
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # ---------------------------------------------------------------------
        # API Routes - User Service (Protected)
        # ---------------------------------------------------------------------
        location /api/user/ {
            # Auth validation via auth service
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/user/(.*) /$1 break;
            
            proxy_pass http://user_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Pass authenticated user info to upstream
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            

            # WebSocket support for real-time messaging
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        location /api/stats/ {
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;

            rewrite ^/api/stats/(.*) /$1 break;
            
            proxy_pass http://stats_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ---------------------------------------------------------------------
        # API Routes - Game Service (Protected)
        # ---------------------------------------------------------------------
        location /api/game/ {
            # Auth validation via auth service
            auth_request /internal/auth/verifyGuest;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/game/(.*) /$1 break;
            
            proxy_pass http://game_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Pass authenticated user info to upstream
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            # WebSocket support for real-time game communication
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # Longer timeout for WebSocket connections
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
        }
 
        # ---------------------------------------------------------------------
        # API Routes - Chat Service WebSocket (Protected)
        # ---------------------------------------------------------------------
        location /api/chat/ {
            # Auth validation via auth service
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/chat/(.*) /$1 break;
            
            proxy_pass http://chat_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            # WebSocket support for real-time messaging
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
        }

        location /api/social/ {
            # Auth validation via auth service
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/social/(.*) /$1 break;
            
            proxy_pass http://social_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            # WebSocket support for real-time messaging
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
        }
        
        # ---------------------------------------------------------------------
        # API Routes - Matchmaking Service (Protected)
        # ---------------------------------------------------------------------
        location /api/matchmaking/ {
            # Auth validation via auth service
            auth_request /internal/auth/verify;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/matchmaking/(.*) /$1 break;
            
            proxy_pass http://matchmaking_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Pass authenticated user info to upstream
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            # WebSocket support for queue updates
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
        }

        location /api/tournament/ {
            # Auth validation via auth service
            auth_request /internal/auth/verifyGuest;
            auth_request_set $auth_user_id $upstream_http_x_user_id;
            auth_request_set $auth_user_email $upstream_http_x_user_email;
            
            rewrite ^/api/tournament/(.*) /$1 break;
            
            proxy_pass http://tournament_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Pass authenticated user info to upstream
            proxy_set_header X-User-Id $auth_user_id;
            proxy_set_header X-User-Email $auth_user_email;
            
            # WebSocket support for real-time tournament updates
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
        }
        
        # ---------------------------------------------------------------------
        # Vite HMR (Hot Module Replacement) WebSocket
        # ---------------------------------------------------------------------
        # Vite uses WebSocket for instant hot reloading during development
        # The HMR client connects to /@vite/client and uses WebSocket
        location /@vite/ {
            proxy_pass http://frontend_upstream;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # HMR requires long-lived connections
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
        }
        
        # Vite WebSocket endpoint for HMR
        location /__vite_ping {
            proxy_pass http://frontend_upstream;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
        }
        
        # ---------------------------------------------------------------------
        # Frontend Application (Default Route)
        # ---------------------------------------------------------------------
        # All other requests go to the Vite dev server
        location / {
            proxy_pass http://frontend_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Vite HMR
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # ---------------------------------------------------------------------
        # Health Check Endpoint
        # ---------------------------------------------------------------------
        # Simple health check for the NGINX proxy itself
        location /nginx-health {
            access_log off;
            return 200 'healthy\n';
            add_header Content-Type text/plain;
        }
    }
}
