services:
  nginx:
    image: nginx:alpine
    container_name: transcendence-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - images-data:/app/images
    networks:
      - transcendence-network
    depends_on:
      auth:
        condition: service_started
      user:
        condition: service_started
      game:
        condition: service_started
      chat:
        condition: service_started
      matchmaking:
        condition: service_started
      tournament:
        condition: service_started
      frontend:
        condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/nginx-health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: transcendence-rabbitmq
    restart: unless-stopped
    mem_limit: 512m
    ports:
      # AMQP protocol port (internal communication)
      - "5672:5672"
      # Management UI
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - transcendence-network
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  auth:
    build:
      context: .
      dockerfile: apps/auth/Dockerfile.dev
    container_name: transcendence-auth
    restart: unless-stopped
    environment:
      NODE_ENV: development
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:-}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET:-}
      PEPPER: ${PEPPER:-dev-pepper-change-in-production}
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/auth:/app/apps/auth
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - auth-node-modules:/app/node_modules
      - auth-data:/app/apps/auth/db
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  user:
    build:
      context: .
      dockerfile: apps/user/Dockerfile.dev
    container_name: transcendence-user
    restart: unless-stopped
    environment:
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/user:/app/apps/user
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - user-node-modules:/app/node_modules
      - user-data:/app/apps/user/db
      - images-data:/app/apps/user/images
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  game:
    build:
      context: .
      dockerfile: apps/game/Dockerfile.dev
    container_name: transcendence-game
    restart: unless-stopped
    environment:
      NODE_ENV: development
      RABBITMQ_URI: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/game:/app/apps/game
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - game-node-modules:/app/node_modules
      - game-data:/app/apps/game/db
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  chat:
    build:
      context: .
      dockerfile: apps/chat/Dockerfile.dev
    container_name: transcendence-chat
    restart: unless-stopped
    environment:
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/chat:/app/apps/chat
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - chat-node-modules:/app/node_modules
      - chat-data:/app/apps/chat/db
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  matchmaking:
    build:
      context: .
      dockerfile: apps/matchmaking/Dockerfile.dev
    container_name: transcendence-matchmaking
    restart: unless-stopped
    environment:
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      USER_SERVICE_URL: http://user:3000
      GAME_SERVICE_URL: http://game:3000
      STATS_SERVICE_URL: http://stats:3000
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/matchmaking:/app/apps/matchmaking
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - matchmaking-node-modules:/app/node_modules
      - matchmaking-data:/app/apps/matchmaking/db
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  tournament:
    build:
      context: .
      dockerfile: apps/tournament/Dockerfile.dev
    container_name: transcendence-tournament
    restart: unless-stopped
    environment:
      NODE_ENV: development
      RABBITMQ_URI: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      GAME_SERVICE_URL: http://game:3000
      ACCESS_TOKEN_NAME: ${ACCESS_TOKEN_NAME:-accessToken}
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/tournament:/app/apps/tournament
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - tournament-node-modules:/app/node_modules
      - tournament-data:/app/apps/tournament/db
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  stats:
    build:
      context: .
      dockerfile: apps/stats/Dockerfile.dev
    container_name: transcendence-stats
    restart: unless-stopped
    environment:
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/stats:/app/apps/stats
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - stats-node-modules:/app/node_modules
      - stats-data:/app/apps/stats/db
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile.dev
    container_name: transcendence-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: development
      VITE_API_URL: http://localhost
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/frontend:/app/apps/frontend
      - ./packages/my-react:/app/packages/my-react
      - ./packages/my-react-router:/app/packages/my-react-router
      - ./packages/my-class-validator:/app/packages/my-class-validator
      - frontend-node-modules:/app/node_modules
    networks:
      - transcendence-network

  worker-mail:
    build:
      context: .
      dockerfile: apps/worker-mail/Dockerfile.dev
    container_name: transcendence-worker-mail
    restart: unless-stopped
    environment:
      NODE_ENV: development
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@rabbitmq:5672
      RESEND_API_KEY: ${RESEND_API_KEY}
      MAIL_FROM: ${MAIL_FROM}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME}
    volumes:
      - ./package.json:/app/package.json:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./apps/worker-mail:/app/apps/worker-mail
      - ./packages/my-fastify-decorators:/app/packages/my-fastify-decorators
      - ./packages/my-fastify-decorators-microservices:/app/packages/my-fastify-decorators-microservices
      - worker-mail-node-modules:/app/node_modules
    networks:
      - transcendence-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: transcendence-tunnel
    restart: unless-stopped
    command: tunnel run
    # Le token est lu depuis le fichier .env
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - transcendence-network

networks:
  transcendence-network:
    name: transcendence-network
    driver: bridge

volumes:
  rabbitmq-data:
    name: transcendence-rabbitmq-data
  auth-node-modules:
    name: transcendence-auth-node-modules
  user-node-modules:
    name: transcendence-user-node-modules
  game-node-modules:
    name: transcendence-game-node-modules
  chat-node-modules:
    name: transcendence-chat-node-modules
  matchmaking-node-modules:
    name: transcendence-matchmaking-node-modules
  tournament-node-modules:
    name: transcendence-tournament-node-modules
  frontend-node-modules:
    name: transcendence-frontend-node-modules
  stats-node-modules:
    name: transcendence-stats-node-modules
  worker-mail-node-modules:
    name: transcendence-worker-mail-node-modules
  auth-data:
    name: transcendence-auth-data
  user-data:
    name: transcendence-user-data
  game-data:
    name: transcendence-game-data
  chat-data:
    name: transcendence-chat-data
  matchmaking-data:
    name: transcendence-matchmaking-data
  stats-data:
    name: transcendence-stats-data
  tournament-data:
    name: transcendence-tournament-data
  images-data:
    name: transcendence-images-data
